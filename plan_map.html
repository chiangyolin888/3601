<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŒ—é«˜360 è£œçµ¦åœ°åœ–æ”»ç•¥</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <style>
        :root {
            --primary-color: #007bff;
            --accent-color: #ffc107;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --danger: #dc3545;
            --success: #28a745;
            --pass: #6c757d;
        }

        body {
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* é ‚éƒ¨æ§åˆ¶å€ */
        header {
            background: #2c3e50;
            color: white;
            padding: 10px;
            text-align: center;
            flex-shrink: 0;
            z-index: 1000;
        }

        h1 { margin: 0; font-size: 1.2rem; }
        
        .controls {
            background: white;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            z-index: 999;
        }

        .mode-switch button {
            padding: 5px 12px;
            border: 1px solid var(--primary-color);
            background: #fff;
            color: var(--primary-color);
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .mode-switch button.active {
            background: var(--primary-color);
            color: #fff;
        }

        .time-input {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        input[type="time"] { padding: 4px; border: 1px solid #ccc; border-radius: 4px; }

        /* åœ°åœ–å€å¡Š */
        #map {
            flex-grow: 1; 
            width: 100%;
            min-height: 40vh; 
            background: #ddd;
            position: relative;
        }

        /* åˆ—è¡¨å€å¡Š (å¯æ²å‹•) */
        #list-view {
            height: 40vh; 
            overflow-y: auto;
            background: #f4f7f6;
            padding: 10px;
            border-top: 2px solid #ccc;
        }

        /* GPS ç‹€æ…‹é¡¯ç¤ºå€ */
        #gps-status {
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8rem;
            z-index: 1000;
        }
        
        /* å…¶ä»–å¡ç‰‡/Legend æ¨£å¼ (æ²¿ç”¨èˆŠç‰ˆ) */
        .stop-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            border-left: 5px solid #ccc;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        .type-cp { border-left-color: var(--danger); }
        .type-start { border-left-color: #17a2b8; }
        .type-finish { border-left-color: var(--accent-color); }
        .type-rest { border-left-color: var(--success); }
        .type-pass { border-left-color: var(--pass); opacity: 0.8; }
        .card-top { display: flex; justify-content: space-between; align-items: center; }
        .loc-name { font-weight: bold; font-size: 1rem; }
        .km-badge { background: #eee; font-size: 0.8rem; padding: 2px 5px; border-radius: 4px; color: #555; }
        .time-info { color: var(--primary-color); font-weight: bold; margin: 5px 0; }
        .t-plus { color: #888; font-size: 0.8rem; font-weight: normal; margin-left: 5px; }
        .nutrition { background: #f8f9fa; padding: 6px; font-size: 0.85rem; border-radius: 4px; margin-top: 5px; border: 1px dashed #ccc; }
        .popup-title { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; }
        .popup-time { color: var(--primary-color); font-weight: bold; }
        .popup-note { font-size: 0.9em; margin-top: 5px; color: #555; }
        .legend {
            position: absolute;
            bottom: 20px;
            left: 10px;
            background: white;
            padding: 5px;
            border-radius: 4px;
            font-size: 0.75rem;
            z-index: 1000;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        .dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 3px; }
    </style>
</head>
<body>

<header>
    <h1>åŒ—é«˜360 åœ°åœ–æ”»ç•¥</h1>
</header>

<div class="controls">
    <div class="mode-switch">
        <button id="btn-20h" class="active" onclick="setMode('20h')">20Hå®Œè³½</button>
        <button id="btn-14h" onclick="setMode('14h')">14Hèè‹±</button>
    </div>
    <div class="time-input">
        <span>å‡ºç™¼:</span>
        <input type="time" id="startTime" value="00:00" onchange="updateAll()">
    </div>
</div>

<div id="map">
    <div id="gps-status">GPS æº–å‚™ä¸­...</div>
    <div class="legend">
        <div><span class="dot" style="background:green;"></span>èµ·é»</div>
        <div><span class="dot" style="background:red;"></span>æª¢æŸ¥é»(CP)</div>
        <div><span class="dot" style="background:blue;"></span>ä¼‘æ¯é»</div>
        <div><span class="dot" style="background:gold;"></span>çµ‚é»</div>
        <div style="margin-top:5px; border-top:1px solid #ddd; padding-top:2px;"><span class="dot" style="background:#dc3545; border:1px solid #fff;"></span>**æ‚¨ç›®å‰ä½ç½®**</div>
    </div>
</div>

<div id="list-view">
    </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    // --- 1. å®šç¾©ç¶“ç·¯åº¦èˆ‡è³‡æ–™ (å«åº§æ¨™) (èˆ‡èˆŠç‰ˆç›¸åŒ) ---
    const coords = {
        'start': [25.1167, 121.4645], 
        'xinwu': [24.9650, 121.0180], 
        'nanliao': [24.8495, 120.9280], 
        'tongxiao': [24.4900, 120.6800], 
        'daan': [24.3500, 120.5800], 
        'shengang': [24.1570, 120.4860], 
        'lukang': [24.0500, 120.4300], 
        'mailiao': [23.7500, 120.2500], 
        'budai': [23.3750, 120.1580], 
        'qigu': [23.1500, 120.1200], 
        'nanzi': [22.7300, 120.3000], 
        'finish': [22.6830, 120.2910] 
    };
    const plan20h = [
        { id: 'p1', type: 'start', loc: 'é—œæ¸¡å®® (èµ·é»)', latlng: coords.start, km: '0k', t: 0, stop: 'å‡ºç™¼', note: 'å‡ºç™¼å‰1å°æ™‚åƒå®Œæ—©é¤' },
        { id: 'p2', type: 'rest', loc: 'æ¡ƒåœ’æ°¸å®‰', latlng: coords.xinwu, km: '45k', t: 110, stop: 'ä¼‘10åˆ†', note: 'è£œæ°´ã€å°å£é£¯ç³°' },
        { id: 'p3', type: 'cp', loc: 'æ–°ç«¹å—å¯® (CP1)', latlng: coords.nanliao, km: '78k', t: 210, stop: 'ä¼‘20åˆ†', note: 'æª¢æŸ¥é»ã€‚é¦™è•‰ã€èƒ½é‡æ£’' },
        { id: 'p4', type: 'rest', loc: 'è‹—æ —é€šéœ„', latlng: coords.tongxiao, km: '125k', t: 350, stop: 'ä¼‘15åˆ†', note: 'åˆé¤(é¹¹é£Ÿä¸‰æ˜æ²»)' },
        { id: 'p5', type: 'rest', loc: 'å°ä¸­å¤§å®‰', latlng: coords.daan, km: '150k', t: 430, stop: 'é¸åœ', note: 'è‹¥æ°´å¤ å¯ä¸åœ' },
        { id: 'p6', type: 'cp', loc: 'å½°åŒ–ä¼¸æ¸¯ (CP2)', latlng: coords.shengang, km: '170k', t: 510, stop: 'ä¼‘20åˆ†', note: 'è£œBCAAã€é¹½éŒ ã€å›ºé«”é£Ÿç‰©' },
        { id: 'p7', type: 'rest', loc: 'å½°åŒ–èŠ³è‹‘', latlng: coords.lukang, km: '200k', t: 610, stop: 'ä¼‘10åˆ†', note: 'å–å¯æ¨‚/å«ç³–é£²æ–™' },
        { id: 'p8', type: 'rest', loc: 'é›²æ—éº¥å¯®', latlng: coords.mailiao, km: '235k', t: 720, stop: 'ä¼‘15åˆ†', note: 'å–èƒ½é‡è† (Gel)æˆ–æµè³ª' },
        { id: 'p9', type: 'cp', loc: 'å˜‰ç¾©å¸ƒè¢‹ (CP3)', latlng: coords.budai, km: '275k', t: 870, stop: 'ä¼‘20åˆ†', note: 'å¤§è£œçµ¦(ç†±æ¹¯)ã€æ‹‰ä¼¸' },
        { id: 'p10', type: 'rest', loc: 'å°å—ä¸ƒè‚¡', latlng: coords.qigu, km: '320k', t: 1020, stop: 'ä¼‘15åˆ†', note: 'å’–å•¡å› æç¥' },
        { id: 'p11', type: 'pass', loc: 'é«˜é›„æ¥ æ¢“', latlng: coords.nanzi, km: '350k', t: 1130, stop: 'ä¸åœ', note: 'å¸‚å€ç´…ç¶ ç‡ˆå¤šï¼Œæ³¨æ„å®‰å…¨' },
        { id: 'p12', type: 'finish', loc: 'é«˜é›„å¤§ç¾©åœ‹ä¸­', latlng: coords.finish, km: '367k', t: 1170, stop: 'å®Œè³½', note: 'æ­å–œå®Œæˆï¼' }
    ];
    const plan14h = [
        { id: 'e1', type: 'start', loc: 'é—œæ¸¡å®® (èµ·é»)', latlng: coords.start, km: '0k', t: 0, stop: 'å‡ºç™¼', note: 'è·Ÿä¸Šé›†åœ˜' },
        { id: 'e2', type: 'pass', loc: 'æ–°ç«¹å—å¯® (CP1)', latlng: coords.nanliao, km: '78k', t: 135, stop: 'åˆ·å¡å³èµ°', note: 'è»Šä¸Šè£œçµ¦ï¼Œæ‹‰é«˜å‡é€Ÿ' },
        { id: 'e3', type: 'rest', loc: 'è‹—æ —é€šéœ„', latlng: coords.tongxiao, km: '125k', t: 230, stop: 'ä¼‘10åˆ†', note: 'è£œæ°´(åŠ ç²‰)ã€åå›ºé«”' },
        { id: 'e4', type: 'pass', loc: 'å½°åŒ–ä¼¸æ¸¯ (CP2)', latlng: coords.shengang, km: '170k', t: 330, stop: 'åˆ·å¡å³èµ°', note: 'æ°´å¤ ä¸åœï¼Œå’¬ç·Šé›†åœ˜' },
        { id: 'e5', type: 'rest', loc: 'é›²æ—éº¥å¯®', latlng: coords.mailiao, km: '230k', t: 465, stop: 'ä¼‘15åˆ†', note: 'å–ç´…ç‰›/å’–å•¡ï¼Œè£œæ»¿æ°´' },
        { id: 'e6', type: 'pass', loc: 'å˜‰ç¾©å¸ƒè¢‹ (CP3)', latlng: coords.budai, km: '275k', t: 570, stop: 'åˆ·å¡å³èµ°', note: 'éå¿…è¦ä¸åœ' },
        { id: 'e7', type: 'rest', loc: 'å°å—ä¸ƒè‚¡', latlng: coords.qigu, km: '310k', t: 660, stop: 'ä¼‘10åˆ†', note: 'æœ€å¾Œè£œæ°´ã€åƒè† ' },
        { id: 'e8', type: 'finish', loc: 'é«˜é›„å¤§ç¾©åœ‹ä¸­', latlng: coords.finish, km: '367k', t: 840, stop: 'å®Œè³½', note: 'èè‹±é”æˆ' }
    ];

    let currentMode = '20h';
    let map;
    let markers = [];
    
    // --- 2. GPS å°ˆç”¨è®Šæ•¸ ---
    let userMarker = null;       // æ‚¨çš„ä½ç½®åœ–æ¨™ (å°ç´…é»)
    let accuracyCircle = null;   // ç²¾æº–åº¦åœ“åœˆ (æ·ºè—è‰²)
    const gpsStatusElement = document.getElementById('gps-status');
    let followUser = true;       // æ˜¯å¦è‡ªå‹•è·Ÿéš¨ä½¿ç”¨è€…ä½ç½®

    // --- 3. åˆå§‹åŒ–åœ°åœ– ---
    function initMap() {
        map = L.map('map').setView([23.8, 120.6], 8);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        // å•Ÿå‹• GPS è¿½è¹¤
        startGpsTracking();

        // ç•¶ä½¿ç”¨è€…æ‰‹å‹•æ‹–æ›³åœ°åœ–æ™‚ï¼Œåœæ­¢è‡ªå‹•è·Ÿéš¨
        map.on('dragstart', function() {
            followUser = false;
        });

        updateAll();
    }

    // --- 4. GPS è¿½è¹¤é‚è¼¯ ---
    function startGpsTracking() {
        if (!navigator.geolocation) {
            gpsStatusElement.textContent = "âŒ è£ç½®ä¸æ”¯æ´ GPS";
            return;
        }

        gpsStatusElement.textContent = "å®šä½æœå‹™å•Ÿå‹•ä¸­...";
        
        navigator.geolocation.watchPosition(
            onLocationFound, 
            onLocationError, 
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 5000 // 5ç§’å…§çš„ä½ç½®å¿«å–
            }
        );
    }

    function onLocationFound(pos) {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const accuracy = pos.coords.accuracy;
        const latlng = [lat, lng];

        const popupContent = `
            <strong>æ‚¨çš„å³æ™‚ä½ç½®</strong><br>
            ç¶“åº¦: ${lng.toFixed(5)}<br>
            ç·¯åº¦: ${lat.toFixed(5)}<br>
            èª¤å·®: Â±${accuracy.toFixed(0)} å…¬å°º
        `;

        if (userMarker === null) {
            // ç¬¬ä¸€æ¬¡å®šä½ï¼šå»ºç«‹åœ–æ¨™å’Œç²¾æº–åº¦åœ“åœˆ
            userMarker = L.circleMarker(latlng, {
                radius: 8,
                color: '#dc3545',
                fillColor: '#dc3545',
                fillOpacity: 1,
                weight: 2
            }).addTo(map).bindPopup(popupContent);

            accuracyCircle = L.circle(latlng, accuracy, {
                weight: 1,
                color: '#1a75ff',
                fillColor: '#1a75ff',
                fillOpacity: 0.1
            }).addTo(map);

            // ç¬¬ä¸€æ¬¡å®šä½æˆåŠŸå¾Œï¼Œç§»å‹•åœ°åœ–åˆ°è©²ä½ç½®
            map.setView(latlng, 15);
            followUser = true;
            
        } else {
            // å¾ŒçºŒæ›´æ–°ï¼šç§»å‹•åœ–æ¨™ã€æ›´æ–°åœ“åœˆåŠå¾‘å’Œä½ç½®
            userMarker.setLatLng(latlng).setPopupContent(popupContent);
            accuracyCircle.setLatLng(latlng).setRadius(accuracy);
            
            // å¦‚æœ followUser æ˜¯ trueï¼Œè‡ªå‹•å¹³ç§»åœ°åœ–
            if (followUser) {
                 map.panTo(latlng);
            }
        }

        gpsStatusElement.textContent = `ğŸŸ¢ å®šä½æˆåŠŸ (èª¤å·®: ${accuracy.toFixed(0)}m)`;
    }

    function onLocationError(error) {
        let message;
        switch(error.code) {
            case error.PERMISSION_DENIED:
                message = "ğŸ”´ æ¬Šé™æ‹’çµ•ï¼Œè«‹å…è¨±ç€è¦½å™¨å®šä½ã€‚";
                break;
            case error.POSITION_UNAVAILABLE:
                message = "ğŸŸ  ä½ç½®ç„¡æ³•ä½¿ç”¨ (GPS è¨Šè™Ÿå·®)";
                break;
            case error.TIMEOUT:
                message = "ğŸŸ¡ å®šä½è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚";
                break;
            default:
                message = "âŒ å®šä½éŒ¯èª¤ã€‚";
        }
        gpsStatusElement.textContent = message;
    }

    // --- 5. èˆŠç‰ˆé‚è¼¯ (æ›´æ–°åœ°åœ–èˆ‡åˆ—è¡¨) (æ²¿ç”¨èˆŠç‰ˆ) ---
    function updateAll() {
        // ... (çœç•¥èˆ‡èˆŠç‰ˆç›¸åŒçš„ updateAll å…§å®¹ï¼Œç¢ºä¿å®ƒè¢«èª¿ç”¨)
        const startTime = document.getElementById('startTime').value;
        const data = currentMode === '20h' ? plan20h : plan14h;
        const listContainer = document.getElementById('list-view');
        
        listContainer.innerHTML = '';
        markers.forEach(m => map.removeLayer(m));
        markers = [];

        data.forEach(item => {
            const realTime = formatTime(item.t, startTime);
            const tPlus = formatTPlus(item.t);
            const markerColor = getMarkerColor(item.type);
            
            const circleIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="background-color:${markerColor}; width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow: 0 0 4px black;"></div>`,
                iconSize: [16, 16],
                iconAnchor: [8, 8],
                popupAnchor: [0, -10]
            });

            const marker = L.marker(item.latlng, {icon: circleIcon}).addTo(map);
            
            const popupContent = `
                <div class="popup-title">${item.loc} (${item.km})</div>
                <div class="popup-time">é è¨ˆ: ${realTime} (${tPlus})</div>
                <div>ç‹€æ…‹: <b>${item.stop}</b></div>
                <div class="popup-note">${item.note}</div>
            `;
            marker.bindPopup(popupContent);
            markers.push(marker);

            const card = document.createElement('div');
            card.className = `stop-card type-${item.type}`;
            card.onclick = () => {
                map.flyTo(item.latlng, 13); 
                marker.openPopup();
            };

            card.innerHTML = `
                <div class="card-top">
                    <span class="loc-name">${item.loc}</span>
                    <span class="km-badge">${item.km}</span>
                </div>
                <div class="time-info">
                    ${realTime} <span class="t-plus">${tPlus}</span>
                    <span style="float:right; font-weight:normal; font-size:0.8rem; color:#333; background:#eee; padding:2px 6px; border-radius:10px;">${item.stop}</span>
                </div>
                <div class="nutrition">ğŸ’¡ ${item.note}</div>
            `;
            listContainer.appendChild(card);
        });

        if(markers.length > 0 && !userMarker) {
            const group = new L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.1));
        }
    }

    // --- è¼”åŠ©å‡½å¼ (æ²¿ç”¨èˆŠç‰ˆ) ---
    function setMode(mode) {
        currentMode = mode;
        document.getElementById('btn-20h').className = mode === '20h' ? 'active' : '';
        document.getElementById('btn-14h').className = mode === '14h' ? 'active' : '';
        updateAll();
    }

    function getMarkerColor(type) {
        switch(type) {
            case 'start': return 'green';
            case 'cp': return 'red';
            case 'finish': return 'gold';
            case 'pass': return 'grey';
            default: return 'blue'; 
        }
    }

    function formatTime(totalMinutes, startTimeStr) {
        if (!startTimeStr) return "--:--";
        const [startH, startM] = startTimeStr.split(':').map(Number);
        let arriveH = startH + Math.floor(totalMinutes / 60);
        let arriveM = startM + (totalMinutes % 60);
        if (arriveM >= 60) { arriveH++; arriveM %= 60; }
        let dayLabel = "";
        if (arriveH >= 24) { arriveH %= 24; dayLabel = "(+1)"; }
        return `${String(arriveH).padStart(2,'0')}:${String(arriveM).padStart(2,'0')}${dayLabel}`;
    }

    function formatTPlus(minutes) {
        const h = Math.floor(minutes / 60);
        const m = minutes % 60;
        return `T+${h}:${String(m).padStart(2,'0')}`;
    }

    // å•Ÿå‹•
    window.onload = initMap;

</script>
</body>
</html>
