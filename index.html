<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŒ—é«˜360 è£œçµ¦åœ°åœ–æ”»ç•¥</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <style>
        :root {
            --primary-color: #007bff;
            --accent-color: #ffc107;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --danger: #dc3545;
            --success: #28a745;
            --pass: #6c757d;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* é ‚éƒ¨æ§åˆ¶å€ */
        header {
            background: #2c3e50;
            color: white;
            padding: 10px;
            text-align: center;
            flex-shrink: 0;
            z-index: 1000;
        }

        h1 { margin: 0; font-size: 1.2rem; }
        
        .controls {
            background: white;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            z-index: 999;
        }

        .mode-switch button {
            padding: 5px 12px;
            border: 1px solid var(--primary-color);
            background: #fff;
            color: var(--primary-color);
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .mode-switch button.active {
            background: var(--primary-color);
            color: #fff;
        }

        .time-input {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        input[type="time"] { padding: 4px; border: 1px solid #ccc; border-radius: 4px; }

        /* åœ°åœ–å€å¡Š */
        #map {
            flex-grow: 1; /* ä½”æ“šå‰©é¤˜ç©ºé–“ */
            width: 100%;
            min-height: 40vh; /* æ‰‹æ©Ÿä¸Šè‡³å°‘ç•™ 40% çµ¦åœ°åœ– */
            background: #ddd;
        }

        /* åˆ—è¡¨å€å¡Š (å¯æ²å‹•) */
        #list-view {
            height: 40vh; /* åˆ—è¡¨é«˜åº¦ */
            overflow-y: auto;
            background: #f4f7f6;
            padding: 10px;
            border-top: 2px solid #ccc;
        }

        /* å¡ç‰‡æ¨£å¼ */
        .stop-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            border-left: 5px solid #ccc;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer; /* è®“ä½¿ç”¨è€…çŸ¥é“å¯ä»¥é» */
        }

        .type-cp { border-left-color: var(--danger); }
        .type-start { border-left-color: #17a2b8; }
        .type-finish { border-left-color: var(--accent-color); }
        .type-rest { border-left-color: var(--success); }
        .type-pass { border-left-color: var(--pass); opacity: 0.8; }

        .card-top { display: flex; justify-content: space-between; align-items: center; }
        .loc-name { font-weight: bold; font-size: 1rem; }
        .km-badge { background: #eee; font-size: 0.8rem; padding: 2px 5px; border-radius: 4px; color: #555; }
        
        .time-info { color: var(--primary-color); font-weight: bold; margin: 5px 0; }
        .t-plus { color: #888; font-size: 0.8rem; font-weight: normal; margin-left: 5px; }
        
        .nutrition { background: #f8f9fa; padding: 6px; font-size: 0.85rem; border-radius: 4px; margin-top: 5px; border: 1px dashed #ccc; }

        /* åœ°åœ– Popup æ¨£å¼å„ªåŒ– */
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .popup-title { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; }
        .popup-time { color: var(--primary-color); font-weight: bold; }
        .popup-note { font-size: 0.9em; margin-top: 5px; color: #555; }

        /* Legend */
        .legend {
            position: absolute;
            bottom: 20px;
            left: 10px;
            background: white;
            padding: 5px;
            border-radius: 4px;
            font-size: 0.75rem;
            z-index: 1000;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
            pointer-events: none; /* è®“é»æ“Šç©¿é€ */
        }
        .dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 3px; }

    </style>
</head>
<body>

<header>
    <h1>åŒ—é«˜360 åœ°åœ–æ”»ç•¥</h1>
</header>

<div class="controls">
    <div class="mode-switch">
        <button id="btn-20h" class="active" onclick="setMode('20h')">20Hå®Œè³½</button>
        <button id="btn-14h" onclick="setMode('14h')">14Hèè‹±</button>
    </div>
    <div class="time-input">
        <span>å‡ºç™¼:</span>
        <input type="time" id="startTime" value="00:00" onchange="updateAll()">
    </div>
</div>

<div id="map">
    <div class="legend">
        <div><span class="dot" style="background:green;"></span>èµ·é»</div>
        <div><span class="dot" style="background:red;"></span>æª¢æŸ¥é»(CP)</div>
        <div><span class="dot" style="background:blue;"></span>ä¼‘æ¯é»</div>
        <div><span class="dot" style="background:gold;"></span>çµ‚é»</div>
    </div>
</div>

<div id="list-view">
    </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    // --- 1. å®šç¾©ç¶“ç·¯åº¦èˆ‡è³‡æ–™ (å«åº§æ¨™) ---
    // åº§æ¨™ç‚ºæ¦‚ç•¥ä½ç½®ï¼Œè¶³ä»¥å°èˆªèˆ‡æª¢è¦–
    const coords = {
        'start': [25.1167, 121.4645], // é—œæ¸¡å®®
        'xinwu': [24.9650, 121.0180], // æ°¸å®‰æ¼æ¸¯é™„è¿‘
        'nanliao': [24.8495, 120.9280], // å—å¯®
        'tongxiao': [24.4900, 120.6800], // é€šéœ„
        'daan': [24.3500, 120.5800], // å¤§å®‰/æ¸…æ°´
        'shengang': [24.1570, 120.4860], // ä¼¸æ¸¯ç¦å®‰å®®
        'lukang': [24.0500, 120.4300], // é¹¿æ¸¯/èŠ³è‹‘
        'mailiao': [23.7500, 120.2500], // éº¥å¯®
        'budai': [23.3750, 120.1580], // å¸ƒè¢‹å¤§çœ¾å»Ÿ
        'qigu': [23.1500, 120.1200], // ä¸ƒè‚¡
        'nanzi': [22.7300, 120.3000], // æ¥ æ¢“
        'finish': [22.6830, 120.2910]  // å·¦ç‡Ÿ/å¤§ç¾©åœ‹ä¸­
    };

    // 20å°æ™‚è¨ˆç•«
    const plan20h = [
        { id: 'p1', type: 'start', loc: 'é—œæ¸¡å®® (èµ·é»)', latlng: coords.start, km: '0k', t: 0, stop: 'å‡ºç™¼', note: 'å‡ºç™¼å‰1å°æ™‚åƒå®Œæ—©é¤' },
        { id: 'p2', type: 'rest', loc: 'æ¡ƒåœ’æ°¸å®‰', latlng: coords.xinwu, km: '45k', t: 110, stop: 'ä¼‘10åˆ†', note: 'è£œæ°´ã€å°å£é£¯ç³°' },
        { id: 'p3', type: 'cp', loc: 'æ–°ç«¹å—å¯® (CP1)', latlng: coords.nanliao, km: '78k', t: 210, stop: 'ä¼‘20åˆ†', note: 'æª¢æŸ¥é»ã€‚é¦™è•‰ã€èƒ½é‡æ£’' },
        { id: 'p4', type: 'rest', loc: 'è‹—æ —é€šéœ„', latlng: coords.tongxiao, km: '125k', t: 350, stop: 'ä¼‘15åˆ†', note: 'åˆé¤(é¹¹é£Ÿä¸‰æ˜æ²»)' },
        { id: 'p5', type: 'rest', loc: 'å°ä¸­å¤§å®‰', latlng: coords.daan, km: '150k', t: 430, stop: 'é¸åœ', note: 'è‹¥æ°´å¤ å¯ä¸åœ' },
        { id: 'p6', type: 'cp', loc: 'å½°åŒ–ä¼¸æ¸¯ (CP2)', latlng: coords.shengang, km: '170k', t: 510, stop: 'ä¼‘20åˆ†', note: 'è£œBCAAã€é¹½éŒ ã€å›ºé«”é£Ÿç‰©' },
        { id: 'p7', type: 'rest', loc: 'å½°åŒ–èŠ³è‹‘', latlng: coords.lukang, km: '200k', t: 610, stop: 'ä¼‘10åˆ†', note: 'å–å¯æ¨‚/å«ç³–é£²æ–™' },
        { id: 'p8', type: 'rest', loc: 'é›²æ—éº¥å¯®', latlng: coords.mailiao, km: '235k', t: 720, stop: 'ä¼‘15åˆ†', note: 'å–èƒ½é‡è† (Gel)æˆ–æµè³ª' },
        { id: 'p9', type: 'cp', loc: 'å˜‰ç¾©å¸ƒè¢‹ (CP3)', latlng: coords.budai, km: '275k', t: 870, stop: 'ä¼‘20åˆ†', note: 'å¤§è£œçµ¦(ç†±æ¹¯)ã€æ‹‰ä¼¸' },
        { id: 'p10', type: 'rest', loc: 'å°å—ä¸ƒè‚¡', latlng: coords.qigu, km: '320k', t: 1020, stop: 'ä¼‘15åˆ†', note: 'å’–å•¡å› æç¥' },
        { id: 'p11', type: 'pass', loc: 'é«˜é›„æ¥ æ¢“', latlng: coords.nanzi, km: '350k', t: 1130, stop: 'ä¸åœ', note: 'å¸‚å€ç´…ç¶ ç‡ˆå¤šï¼Œæ³¨æ„å®‰å…¨' },
        { id: 'p12', type: 'finish', loc: 'é«˜é›„å¤§ç¾©åœ‹ä¸­', latlng: coords.finish, km: '367k', t: 1170, stop: 'å®Œè³½', note: 'æ­å–œå®Œæˆï¼' }
    ];

    // 14å°æ™‚è¨ˆç•«
    const plan14h = [
        { id: 'e1', type: 'start', loc: 'é—œæ¸¡å®® (èµ·é»)', latlng: coords.start, km: '0k', t: 0, stop: 'å‡ºç™¼', note: 'è·Ÿä¸Šé›†åœ˜' },
        { id: 'e2', type: 'pass', loc: 'æ–°ç«¹å—å¯® (CP1)', latlng: coords.nanliao, km: '78k', t: 135, stop: 'åˆ·å¡å³èµ°', note: 'è»Šä¸Šè£œçµ¦ï¼Œæ‹‰é«˜å‡é€Ÿ' },
        { id: 'e3', type: 'rest', loc: 'è‹—æ —é€šéœ„', latlng: coords.tongxiao, km: '125k', t: 230, stop: 'ä¼‘10åˆ†', note: 'è£œæ°´(åŠ ç²‰)ã€åå›ºé«”' },
        { id: 'e4', type: 'pass', loc: 'å½°åŒ–ä¼¸æ¸¯ (CP2)', latlng: coords.shengang, km: '170k', t: 330, stop: 'åˆ·å¡å³èµ°', note: 'æ°´å¤ ä¸åœï¼Œå’¬ç·Šé›†åœ˜' },
        { id: 'e5', type: 'rest', loc: 'é›²æ—éº¥å¯®', latlng: coords.mailiao, km: '230k', t: 465, stop: 'ä¼‘15åˆ†', note: 'å–ç´…ç‰›/å’–å•¡ï¼Œè£œæ»¿æ°´' },
        { id: 'e6', type: 'pass', loc: 'å˜‰ç¾©å¸ƒè¢‹ (CP3)', latlng: coords.budai, km: '275k', t: 570, stop: 'åˆ·å¡å³èµ°', note: 'éå¿…è¦ä¸åœ' },
        { id: 'e7', type: 'rest', loc: 'å°å—ä¸ƒè‚¡', latlng: coords.qigu, km: '310k', t: 660, stop: 'ä¼‘10åˆ†', note: 'æœ€å¾Œè£œæ°´ã€åƒè† ' },
        { id: 'e8', type: 'finish', loc: 'é«˜é›„å¤§ç¾©åœ‹ä¸­', latlng: coords.finish, km: '367k', t: 840, stop: 'å®Œè³½', note: 'èè‹±é”æˆ' }
    ];

    let currentMode = '20h';
    let map;
    let markers = [];

    // --- 2. åˆå§‹åŒ–åœ°åœ– ---
    function initMap() {
        // å…ˆå®šä½åœ¨å°ç£ä¸­é–“
        map = L.map('map').setView([23.8, 120.6], 8);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        updateAll();
    }

    // --- 3. æ ¸å¿ƒé‚è¼¯ï¼šæ›´æ–°åœ°åœ–èˆ‡åˆ—è¡¨ ---
    function updateAll() {
        const startTime = document.getElementById('startTime').value;
        const data = currentMode === '20h' ? plan20h : plan14h;
        const listContainer = document.getElementById('list-view');
        
        // æ¸…ç©ºåˆ—è¡¨
        listContainer.innerHTML = '';
        
        // æ¸…ç©ºåœ°åœ–æ¨™è¨˜
        markers.forEach(m => map.removeLayer(m));
        markers = [];

        // ä¾åºå»ºç«‹è³‡æ–™
        data.forEach(item => {
            // è¨ˆç®—æ™‚é–“
            const realTime = formatTime(item.t, startTime);
            const tPlus = formatTPlus(item.t);
            
            // --- A. è™•ç†åœ°åœ–æ¨™è¨˜ (Marker) ---
            const markerColor = getMarkerColor(item.type);
            
            // ä½¿ç”¨è‡ªå®šç¾©åœ“é»åœ–ç¤º
            const circleIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="background-color:${markerColor}; width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow: 0 0 4px black;"></div>`,
                iconSize: [16, 16],
                iconAnchor: [8, 8],
                popupAnchor: [0, -10]
            });

            const marker = L.marker(item.latlng, {icon: circleIcon}).addTo(map);
            
            // è¨­å®š Popup å…§å®¹
            const popupContent = `
                <div class="popup-title">${item.loc} (${item.km})</div>
                <div class="popup-time">é è¨ˆ: ${realTime} (${tPlus})</div>
                <div>ç‹€æ…‹: <b>${item.stop}</b></div>
                <div class="popup-note">${item.note}</div>
            `;
            marker.bindPopup(popupContent);
            markers.push(marker);

            // --- B. è™•ç†åˆ—è¡¨å¡ç‰‡ (Card) ---
            const card = document.createElement('div');
            card.className = `stop-card type-${item.type}`;
            card.onclick = () => {
                // é»æ“Šå¡ç‰‡æ™‚ï¼Œåœ°åœ–ç§»å‹•åˆ°è©²é»ä¸¦æ‰“é–‹ Popup
                map.flyTo(item.latlng, 13); // 13æ˜¯ç¸®æ”¾å±¤ç´š
                marker.openPopup();
            };

            card.innerHTML = `
                <div class="card-top">
                    <span class="loc-name">${item.loc}</span>
                    <span class="km-badge">${item.km}</span>
                </div>
                <div class="time-info">
                    ${realTime} <span class="t-plus">${tPlus}</span>
                    <span style="float:right; font-weight:normal; font-size:0.8rem; color:#333; background:#eee; padding:2px 6px; border-radius:10px;">${item.stop}</span>
                </div>
                <div class="nutrition">ğŸ’¡ ${item.note}</div>
            `;
            listContainer.appendChild(card);
        });

        // èª¿æ•´åœ°åœ–è¦–é‡ä»¥åŒ…æ¶µæ‰€æœ‰é»
        if(markers.length > 0) {
            const group = new L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.1));
        }
    }

    // --- è¼”åŠ©å‡½å¼ ---
    function setMode(mode) {
        currentMode = mode;
        document.getElementById('btn-20h').className = mode === '20h' ? 'active' : '';
        document.getElementById('btn-14h').className = mode === '14h' ? 'active' : '';
        updateAll();
    }

    function getMarkerColor(type) {
        switch(type) {
            case 'start': return 'green';
            case 'cp': return 'red';
            case 'finish': return 'gold';
            case 'pass': return 'grey';
            default: return 'blue'; // rest
        }
    }

    function formatTime(totalMinutes, startTimeStr) {
        if (!startTimeStr) return "--:--";
        const [startH, startM] = startTimeStr.split(':').map(Number);
        let arriveH = startH + Math.floor(totalMinutes / 60);
        let arriveM = startM + (totalMinutes % 60);
        if (arriveM >= 60) { arriveH++; arriveM %= 60; }
        let dayLabel = "";
        if (arriveH >= 24) { arriveH %= 24; dayLabel = "(+1)"; }
        return `${String(arriveH).padStart(2,'0')}:${String(arriveM).padStart(2,'0')}${dayLabel}`;
    }

    function formatTPlus(minutes) {
        const h = Math.floor(minutes / 60);
        const m = minutes % 60;
        return `T+${h}:${String(m).padStart(2,'0')}`;
    }

    // å•Ÿå‹•
    window.onload = initMap;

</script>
</body>
</html>
